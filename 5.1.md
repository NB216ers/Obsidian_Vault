## TLS 协议
### TLS 协议的历史

TLS 有20多年的历史，它有很多协议，我们目前比较关注 TLS1.3 协议。

![[Pasted image 20221025110818.png]]
### TLS 相关内容
- AES 加密算法
- ==传递对称加密的密钥是非常困难的事情==，引出非对称加密算法
- 为了解决身份认证问题，引入证书，和证书相关管理措施】

### TLS 设计目的
- 身份认证
- 保密性
- 完整性
身份认证解决“和我通讯的那个人是不是那个人”。
保密性：传输的所有信息具有保密性，就算第三方拿到了我传递的信息，也不知道我传输的明文是什么。
完整性：保证传输消息的完整性

### TLS 协议
- Record 记录协议
	- 对称加密 [^1]
- Hashshake 握手协议 [^2]
	- 验证通讯双发身份[^3]
	- 交换加密解密的安全套件
	- 协商加密参数
### TLS安全密码套件解读
![[Pasted image 20221025111657.png]]






## 对称加密的工作原理
### 对称加密
加解密的密钥是同一把。
### AES 对称加密在网络中的应用
发送方把明文 通过密钥k 用AES 加密函数 加密成 密文C , 密文C 通过网络传输 给接收方，接收方通过密钥K 用AES 解密函数解密成密文C成 明文。

### 对称加密与 XOR 异或运算
对称加密的基本原理是应用异或运算的特性。
密钥 对 明文进行 XOR 生成的 密文。 在次用密钥对密文 XOR 就能得到明文。

![[Pasted image 20221025113426.png]]

XOR 运算特别快，遍历一遍就好了。
#### 填充（padding)
密钥长度固定，无法和明文的字节码进行异或，需要对明文的字节码按照密钥长度进行==分组==。如果 最后一组不够密钥长度，那么要对最后一组进行填充;
- 填充方法
	- 位填充: 以bit位为单位进行填充
	- 字节填充：以字节为单位来填充
		- 补零
		- ANSI X9.23
		- ISO 10126
		- PKCS7 (RFC5652)

### 分组工作模式
#### ECB(Electronic codebook) 模式
- 直接将明文分成多个块，对每个独立的块加密
- 问题：无法隐藏数据特征
![[Pasted image 20221025123857.png]]

#### CBC (Cipher-block chaining) 模式
- 每个明文块先与前一个密文块进行异或后，在进行加密
- 问题： 加密过程串行化 加密过程很慢，无法发挥CPU多核心

#### CTR（Counter) 模式
- 通过递增一个加密计数器以产生连续的密钥流（即隐藏了数据特征，又可以并行执行）
- 问题：不能提供密文消息完整性校验
![[Pasted image 20221025125138.png]]
#### 验证数据完整性：hash函数

- ==MAC(Message Authentication Code)==[^4]
![[Pasted image 20221025124848.png]]
#### GCM
- Galois/Counter Mode
	- CTR + GMAC
![[Pasted image 20221025125054.png]]



[^1]: 使用对称加密解决保密性,发送方可以加密，接收方解密。这就需要传递密钥。
[^2]: 握手协议来完成 对称密钥的传递，传递并不是真正网络中传输密钥，而是双方通过交换安全套件和协商加密参数各自构造出对称加密密钥。
[^3]: 主要通过证书来完成
[^4]: 基于 hash 算法
## 详解AES对称加密算法
### AES (Advanced Encryption Standard) 加密算法
- 比利时密码学家 Joan Daemen 和 Vincent Rijmen 所设计，又称 Rijndael 加密算法
- 常用填充算法：PKCS7
- 常用分组工作模式：GCM
### AES 三种密钥长度
- 分组长度是 128位 （16字节）
| AES     | 密钥长度（32位比特） | 分组长度（32位比特 | 加密轮数 |
| ------- | -------------------- | ------------------ | -------- |
| AES-128 | 4                    | 4                  | 10       |
| AES-192 | 6                    | 4                  | 12       |
| AES-256 | 8                    | 4                  | 14         |
### AES 加密步骤
1. 把明文按照 128 bit (16字节) 拆分成若干个明文块，每个明文块是（4*4）矩阵
2. 按照选择的填充方式填充最后一个明文块
==3. 每一个明文块利用 AES 加密器和密钥，加密成密文块==
4. 拼接所有的密文块，成为最终的密文结果




## 非对称加密和 RSA 算法

> [!NOTE] 对称加密最大的问题
> 如何传递密钥！！！


### 非对称密码
- 每一个参与方都有一对密钥
	- 公钥
		- 向对方公开
	- 私钥
		- 仅自己使用


> [!NOTE] 密钥的特点！！！
> 一对密钥中，公钥加密的消息，只有私钥才能解密。私钥加密的消息，只有公钥才能解密。[^5]公钥加密的消息，公钥是不能解密的！！！

### 非对称加解密过程
- 加密
	- 使用对方的公钥加密消息
- 解密
	- 使用自己的私钥解密消息
![[Pasted image 20221025132019.png]]

> [!NOTE] 怎么拿到对方的公钥呢？
> 
> 1. 基于PKI 基础设施 从第三分哪里获得。
> 2. 建立连接过程中，先通过一次握手，比如 TLS 握手，在握手中，服务端把公钥发送给发起端

### RSA 算法
- 1977 年提出，名字是由发明者的名字来命名
- 早期用来在TLS握手过程中传送对称加密中的密钥。现在主要使用RSA算法来生成 CA 证书。

#### RSA 算法中公私钥的产生
![[Pasted image 20221025132948.png]]




![[Pasted image 20221025133411.png]]




[^5]: 私钥加密，公钥解密，相当于在签名

## 使用 openssl 基于 RSA 算法生成公私钥


## 非对称密码应用：PKI 证书体系
### 数字签名
- ==基于私钥加密，只能使用公钥解密：起到身份认证的使用==
- ==公钥管理： Public Key Infrastructure (PKI) 公钥基础设施==
	- 由 Certificate Authority (CA) 数字证书认证机构将用户个人身份和公开密钥关联在一起
	- 公钥数字证书组成
		- CA 信息、公钥用户信息、公钥、权威机构签字、有效期
	- PKI 用户
		- 向 CA 注册公钥的用户
		- 希望使用已注册公钥的用户



