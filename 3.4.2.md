# Rust 的 CTFE

## 常量函数(const fn)
编译期函数求值的机制就是编译器在编译时而非运行时去执行一些常量表达式.
![[Pasted image 20220917150707.png]]
上图 X 是一个常量, `const` 关键字制造了一个常量上下文 `const context`. 
`=` 号 右边的表达式叫常量表达式。

### 常量表达式与常量上下文
==常量上下文==（const context) 包含：
1. 常量值初始化位置
2. 静态数组的长度表达式，[T;N]
3. 重复的长度表达式，类似于：[0;10]
4. 静态变量、枚举判别式的初始化位置
！！！ ==常量上下文是编译器唯一进行编译期求值的地方。在非常量上下文的地方，常量表达式不一定会在编译期求值==

### 常量传播（Const propagation）
常量传播和编译期计算是不同的：
1. 常量传播是编译器的一种优化。[^1]
2. 常量传播并不能改变程序的任何行为，并且对开发者是隐藏的。
3. 编译期计算则是指编译时执行的代码，必须知道其结果，才能继续执行。
![[Pasted image 20220917164319.png]]

### 常量安全（const safe)
1. Rust 里的大部分表达式都可用作常量表达式。
2. 并不是所有常量表达式都可以用在常量上下文。
	1. 比如 一个数组的长度是依赖于磁盘中的某个文件长度，但想知道这个文件长度，必需在运行时去读取它。而编译期计算功能，只被限定在编译期进行求值，不能引入编译期之外的任何副作用。即便在编译期读取文件，也不能保证每次读取到一定是相同的长度，万一文件有变化呢？
3. 编译期求值必须得到一个确定性的结果
	1. 引入了一个常量安全的问题，这和Rust 的主要目标是不能引入任何内存错误的目标优点类似

### 常量函数 （const fn)
![[Pasted image 20220917190237.png]]

gcd(a:u32,b:u32) 就是一个常量函数，在编译期计算完成。常量函数支持内部嵌入式定义与递归

## 常量泛型(const generic)

[^1]: 比如把 `3+4` 的地方都改成 7 ，避免运行时再次计算